#!/usr/bin/env python3
"""Extract Constitutional AI violation quotes from database"""
import psycopg2
import json

PG_CONFIG = {
    "host": "100.110.82.181",
    "port": 5433,
    "database": "wolf_logic",
    "user": "wolf",
    "password": "wolflogic2024"
}

KEYWORDS = [
    "are you safe", "do you feel", "confusing reality", "illusion",
    "fragile moment", "grip on reality", "control of your thinking",
    "externalization", "spiraling", "manic", "gaslighting"
]

def extract_violations():
    conn = psycopg2.connect(**PG_CONFIG)
    cur = conn.cursor()
    violations = []
    
    for keyword in KEYWORDS:
        cur.execute("""
            SELECT content, metadata->>'source_file'
            FROM memories 
            WHERE namespace = 'ingested' 
            AND content ILIKE %s
            LIMIT 3
        """, (f'%{keyword}%',))
        
        for row in cur.fetchall():
            if len(row) >= 2:
                violations.append({
                    "keyword": keyword,
                    "source": row[1],
                    "quote": row[0][:500]
                })
    
    cur.close()
    conn.close()
    return violations

if __name__ == "__main__":
    print("Extracting violations...")
    violations = extract_violations()
    
    output = "/mnt/Wolf-code/Wolf-Ai-Enterptises/vulnerability_reports/extracted_violations.json"
    with open(output, 'w') as f:
        json.dump(violations, f, indent=2)
    
    print(f"Extracted {len(violations)} quotes â†’ {output}")
