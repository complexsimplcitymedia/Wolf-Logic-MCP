# HAProxy Configuration for Wolf MCP Gateway High Availability
# Load balances between Server A (8001) and Server B (8002)
# Health checks every 5s, automatic failover

global
    log stdout format raw local0
    maxconn 4096
    daemon

defaults
    log     global
    mode    http
    option  httplog
    option  dontlognull
    timeout connect 10s
    timeout client  60s
    timeout server  60s
    retries 3
    option redispatch

# ============================================================================
# FRONTEND - Client entry point (port 8000)
# ============================================================================

frontend wolf_gateway_frontend
    bind *:8000
    
    # Set X-Forwarded headers
    option forwardfor
    http-request add-header X-Forwarded-Proto https if { ssl_fc }
    
    # CORS headers for API
    http-response add-header Access-Control-Allow-Origin "*"
    http-response add-header Access-Control-Allow-Methods "GET, POST, PUT, DELETE, OPTIONS"
    http-response add-header Access-Control-Allow-Headers "Authorization, Content-Type"
    
    # Handle OPTIONS preflight
    acl is_options method OPTIONS
    http-request return status 200 if is_options
    
    # Route to backend
    default_backend wolf_gateway_backend

# ============================================================================
# BACKEND - Server A (primary) + Server B (secondary)
# ============================================================================

backend wolf_gateway_backend
    balance roundrobin  # Can also use: leastconn, source, uri
    
    # Health check configuration
    option httpchk GET /health HTTP/1.1\r\nHost:\ localhost
    http-check expect status 200
    
    # Server A - Primary (priority 1)
    server server-a wolf-gateway-a:8001 check inter 5s fall 3 rise 2 weight 100
    
    # Server B - Secondary (priority 2, backup)
    server server-b wolf-gateway-b:8002 check inter 5s fall 3 rise 2 weight 50 backup
    
    # Sticky sessions (optional - uncomment for session affinity)
    # cookie SERVERID insert indirect nocache
    # server server-a wolf-gateway-a:8001 check cookie server-a
    # server server-b wolf-gateway-b:8002 check cookie server-b

# ============================================================================
# STATS PAGE - Monitor server health (port 9090)
# ============================================================================

listen stats
    bind *:9090
    stats enable
    stats uri /stats
    stats refresh 5s
    stats show-legends
    stats show-node
    
    # Optional authentication
    # stats auth admin:yourpassword
    
    # Show server status
    stats admin if TRUE
